{% extends "base.html" %}

{% block title %}AI Scholar - Academic Paper Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block body_class %}home-page{% endblock %}

{% block content %}
<div class="home-container">
    <div class="row">
        <!-- Search History Sidebar -->
        <div class="col-lg-3">
            <div class="search-history-section animate-on-scroll">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-history me-2"></i>Previous Searches</h5>
                    <button id="clearHistoryButtonIndex" class="btn btn-outline-secondary clear-history-btn">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <div id="searchHistoryTabs">
                    {% if recent_searches %}
                        {% for search in recent_searches %}
                        <div class="search-history-item list-group-item" 
                             data-query="{{ search.query }}" 
                             data-backend="{{ search.backend }}" 
                             data-mode="{{ search.mode }}"
                             data-search-id="{{ search.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="query-text">{{ search.query }}</div>
                                    <div class="search-meta">
                                        <i class="fas fa-database me-1"></i>{{ search.backend }}
                                        <span class="mx-1">•</span>
                                        <i class="fas fa-clock me-1"></i>{{ search.created_at.strftime('%m/%d %H:%M') }}
                                        {% if search.results_count %}
                                        <span class="mx-1">•</span>
                                        <i class="fas fa-file-alt me-1"></i>{{ search.results_count }} results
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="search-actions">
                                    <span class="badge bg-primary me-2">{{ search.mode }}</span>
                                    <button class="btn btn-outline-danger btn-sm delete-search-btn" 
                                            data-search-id="{{ search.id }}" 
                                            data-query="{{ search.query }}"
                                            title="Delete this search">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-3 opacity-50"></i>
                            <p><em>No previous searches</em></p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Main Search Section -->
        <div class="col-lg-9">
            <div class="main-search-section animate-on-scroll">
                <h3><i class="fas fa-search me-2"></i>Academic Paper Search</h3>
                
                <form id="searchForm" method="post" novalidate>
                    <!-- Main Search Input -->
                    <div class="search-input-group">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   name="query" 
                                   placeholder="Enter your search query (e.g., machine learning, climate change, quantum computing)"
                                   value="{{ query }}" 
                                   required
                                   autocomplete="off">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </div>

                    <!-- Search Options -->
                    <div class="search-options">
                        <!-- Data Source -->
                        <div class="option-group">
                            <label for="backend" class="form-label">
                                <i class="fas fa-database me-2"></i>Data Source
                            </label>
                            <select name="backend" id="backend" class="form-select">
                                <option value="crossref" {% if selected_backend=='crossref' %}selected{% endif %}>CrossRef</option>
                                <option value="arxiv" {% if selected_backend=='arxiv' %}selected{% endif %}>arXiv</option>
                                <option value="semantic_scholar" {% if selected_backend=='semantic_scholar' %}selected{% endif %}>Semantic Scholar</option>
                                <option value="core" {% if selected_backend=='core' %}selected{% endif %}>CORE</option>
                                <option value="openalex" {% if selected_backend=='openalex' %}selected{% endif %}>OpenAlex</option>
                            </select>
                        </div>

                        <!-- Search Mode -->
                        <div class="option-group">
                            <label class="form-label">
                                <i class="fas fa-sliders-h me-2"></i>Search Mode
                            </label>
                            <div class="mode-options">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mode" id="modeRegular" value="regular" 
                                           {% if mode != 'aggregate' %}checked{% endif %}>
                                    <label class="form-check-label" for="modeRegular">
                                        <strong>Regular Search</strong>
                                        <small class="d-block text-muted">Search single provider</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mode" id="modeAggregate" value="aggregate"
                                           {% if mode == 'aggregate' %}checked{% endif %}>
                                    <label class="form-check-label" for="modeAggregate">
                                        <strong>Aggregate Search</strong>
                                        <small class="d-block text-muted">AI-powered multi-provider search</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Year Range -->
                        <div class="option-group">
                            <label class="form-label">
                                <i class="fas fa-calendar-alt me-2"></i>Year Range
                            </label>
                            <div class="year-range-inputs">
                                <input type="number" 
                                       class="form-control" 
                                       name="min_year" 
                                       id="minYear"
                                       placeholder="Min year (e.g., 2020)" 
                                       value="{{ min_year }}"
                                       min="1900"
                                       max="2030">
                                <span>to</span>
                                <input type="number" 
                                       class="form-control" 
                                       name="max_year" 
                                       id="maxYear"
                                       placeholder="Max year (e.g., 2024)" 
                                       value="{{ max_year }}"
                                       min="1900"
                                       max="2030">
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Form Groups -->
                    <div class="search-options">
                        <!-- AI Ranking Mode (for aggregate) -->
                        <div class="option-group dynamic-group" id="rankingModeGroup" 
                             {% if mode != 'aggregate' %}style="display:none"{% endif %}>
                            <label for="rankingMode" class="form-label">
                                <i class="fas fa-robot me-2"></i>AI Ranking Mode
                            </label>
                            <select name="ranking_mode" id="rankingMode" class="form-select">
                                <option value="ai" {% if ranking_mode == 'ai' %}selected{% endif %}>AI Relevance Ranking</option>
                                <option value="citations" {% if ranking_mode == 'citations' %}selected{% endif %}>Most Cited Papers</option>
                                <option value="year" {% if ranking_mode == 'year' %}selected{% endif %}>Newest Papers First</option>
                            </select>
                            <div id="ranking-mode-explanation" class="form-text text-info mt-2">
                                <div id="ai-ranking-explanation" {% if ranking_mode != 'ai' %}style="display:none"{% endif %}>
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>AI Relevance Ranking:</strong> Searches all providers (CrossRef, arXiv, Semantic Scholar, CORE, OpenAlex), 
                                    removes duplicates, and uses Google Gemini AI to intelligently rank papers by relevance to your query. 
                                    Balances established, well-cited research with cutting-edge innovations (especially from arXiv). 
                                    Each paper gets a personalized explanation from the AI about why it's relevant.
                                </div>
                                <div id="citations-ranking-explanation" {% if ranking_mode != 'citations' %}style="display:none"{% endif %}>
                                    <i class="fas fa-quote-right me-1"></i>
                                    <strong>Most Cited:</strong> Focuses on providers with citation data, optimized to find highly cited papers.
                                </div>
                                <div id="year-ranking-explanation" {% if ranking_mode != 'year' %}style="display:none"{% endif %}>
                                    <i class="fas fa-calendar me-1"></i>
                                    <strong>Newest First:</strong> Orders papers by publication date (newest first).
                                </div>
                            </div>
                        </div>

                        <!-- Result Limit (for regular) -->
                        <div class="option-group dynamic-group" id="resultLimitGroup" 
                             {% if mode == 'aggregate' %}style="display:none"{% endif %}>
                            <label for="resultLimit" class="form-label">
                                <i class="fas fa-list-ol me-2"></i>Number of Results
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   name="result_limit" 
                                   id="resultLimit"
                                   placeholder="Default: 50" 
                                   value="{{ result_limit }}"
                                   min="1"
                                   max="500">
                        </div>

                        <!-- AI Result Limit (for aggregate) -->
                        <div class="option-group dynamic-group" id="aiResultLimitGroup" 
                             {% if mode != 'aggregate' %}style="display:none"{% endif %}>
                            <label for="aiResultLimit" class="form-label">
                                <i class="fas fa-brain me-2"></i>AI-Ranked Results
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   name="ai_result_limit" 
                                   id="aiResultLimit"
                                   placeholder="Default: 50" 
                                   value="{{ ai_result_limit }}"
                                   min="1"
                                   max="100">
                        </div>
                    </div>
                </form>

                <!-- Quick Search Suggestions -->
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>Popular searches:
                    </small>
                    <div id="quickSearchContainer" class="mt-2">
                        <!-- Quick search buttons will be added by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    {% if results %}
    <div class="results-section animate-on-scroll">
        <div class="result-stats">
            <div class="stats-header">
                <h4><i class="fas fa-chart-bar me-2"></i>Search Results</h4>
                <div class="filter-controls">
                    <label for="result-filter" class="filter-label">
                        <i class="fas fa-filter me-1"></i>Sort by:
                    </label>
                    <select id="result-filter" class="filter-select result-filter">
                        <option value="default">Default Order</option>
                        <option value="citations">Citations (High to Low)</option>
                        <option value="year">Year (Newest First)</option>
                        <option value="title">Title (A-Z)</option>
                        {% if mode == 'aggregate' %}
                        <option value="provider">Provider</option>
                        {% endif %}
                    </select>
                </div>
            </div>
            <p>Found <strong>{{ papersCount }}</strong> academic papers matching your query</p>
        </div>

        <div class="result-grid">
            {% for result_group in results %}
            <div class="result-provider-section">
                <h5 class="mb-3">
                    <i class="fas fa-folder-open me-2"></i>
                    {{ result_group['source'].title() }} 
                    <span class="badge bg-secondary">{{ result_group['papers']|length }} papers</span>
                </h5>

                <div class="row">
                    {% for paper in result_group['papers'] %}
                    <div class="col-lg-6 mb-3">
                        <div class="result-card shadow-hover">
                            <a href="{{ paper['url'] }}" target="_blank" rel="noopener" class="paper-title">
                                {{ paper['title'] }}
                                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                            </a>
                            
                            <div class="paper-meta">
                                {% if paper['authors'] %}
                                <div class="meta-item">
                                    <i class="fas fa-users"></i>
                                    <span>{{ paper['authors'] }}</span>
                                </div>
                                {% endif %}
                                
                                {% if paper['year'] %}
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>{{ paper['year'] }}</span>
                                </div>
                                {% endif %}
                                
                                {% if paper['citations'] %}
                                <div class="meta-item">
                                    <i class="fas fa-quote-right"></i>
                                    <span>{{ paper['citations'] }} citations</span>
                                </div>
                                {% endif %}
                            </div>

                            {% if paper['explanation'] %}
                            <div class="ai-ranking">
                                <span class="ranking-label">
                                    <i class="fas fa-robot me-1"></i>AI Ranking:
                                </span>
                                {{ paper['explanation'] }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}