<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scholar Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">Scholar Search</a>
      <div class="navbar-nav ms-auto">
        {% if current_user.is_authenticated %}
          <span class="navbar-text me-3">Welcome, {{ current_user.username }}!</span>
          <a class="nav-link" href="{{ url_for('main.history') }}">History</a>
          <a class="nav-link" href="{{ url_for('auth.profile') }}">Profile</a>
          <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
        {% else %}
          <a class="nav-link" href="{{ url_for('auth.login') }}">Login</a>
          <a class="nav-link" href="{{ url_for('auth.register') }}">Register</a>
        {% endif %}
      </div>
      <div class="form-check form-switch text-light">
        <input class="form-check-input" type="checkbox" id="darkModeToggle">
        <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
      </div>
    </div>
  </nav>

  <!-- Loader Overlay -->
  <div id="loader-overlay">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container-fluid my-5" id="app">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row">
      <div class="col-md-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Previous Searches</h5>
          <button id="clearHistoryButton" class="btn btn-secondary btn-sm">Clear</button>
        </div>
        <ul id="searchHistoryTabs" class="list-group">
          {% if recent_searches %}
            {% for search in recent_searches %}
              <li class="list-group-item d-flex justify-content-between align-items-center" 
                  data-query="{{ search.query }}" 
                  data-backend="{{ search.backend }}" 
                  data-mode="{{ search.mode }}"
                  data-search-id="{{ search.id }}">
                <div class="flex-grow-1" style="cursor: pointer;">
                  <strong>{{ search.query }}</strong>
                  <br>
                  <small class="text-muted">
                    {{ search.backend }} • {{ search.created_at.strftime('%m/%d %H:%M') }}
                    {% if search.results_count %}• {{ search.results_count }} results{% endif %}
                  </small>
                </div>
                <div class="d-flex align-items-center">
                  <span class="badge bg-primary rounded-pill me-2">{{ search.mode }}</span>
                  <button class="btn btn-outline-danger btn-sm delete-search-btn" 
                          data-search-id="{{ search.id }}" 
                          data-query="{{ search.query }}"
                          title="Delete this search">
                    ×
                  </button>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li class="list-group-item text-muted text-center">
              <em>No previous searches</em>
            </li>
          {% endif %}
        </ul>
      </div>

      <div class="col-md-9">
        <form id="searchForm" method="post" class="mb-4">
          <div class="input-group mb-3">
            <input type="text" class="form-control" name="query" placeholder="Enter your search query"
              value="{{ query }}" required>
            <button class="btn btn-primary" type="submit">Search</button>
          </div>
          <div class="mb-3">
            <label for="backend" class="form-label">Select Data Source (for regular search):</label>
            <select name="backend" id="backend" class="form-select">
              <option value="semantic_scholar" {% if selected_backend=='semantic_scholar' %}selected{% endif %}>Semantic
                Scholar</option>
              <option value="arxiv" {% if selected_backend=='arxiv' %}selected{% endif %}>arXiv</option>
              <option value="crossref" {% if selected_backend=='crossref' %}selected{% endif %}>CrossRef</option>
              <option value="core" {% if selected_backend=='core' %}selected{% endif %}>CORE</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Search Mode:</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="mode" id="modeRegular" value="regular" checked>
              <label class="form-check-label" for="modeRegular">Regular Search</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="mode" id="modeAggregate" value="aggregate">
              <label class="form-check-label" for="modeAggregate">Aggregate Search</label>
            </div>
          </div>
          <div class="mb-3" id="rankingModeGroup" {% if mode != 'aggregate' %}style="display:none"{% endif %}>
            <label for="rankingMode" class="form-label">Ranking Mode:</label>
            <select name="ranking_mode" id="rankingMode" class="form-select">
              <option value="ai" {% if ranking_mode == 'ai' %}selected{% endif %}>AI Ranked</option>
              <option value="citations" {% if ranking_mode == 'citations' %}selected{% endif %}>Most Cited</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="yearRange" class="form-label">Year Range:</label>
            <div class="d-flex align-items-center gap-2">
              <input type="number" class="form-control form-control-sm w-25" name="min_year" id="minYear"
                placeholder="Min" value="{{ min_year }}">
              <span class="mx-1">to</span>
              <input type="number" class="form-control form-control-sm w-25" name="max_year" id="maxYear"
                placeholder="Max" value="{{ max_year }}">
            </div>
          </div>
          <div class="mb-3" id="resultLimitGroup" {% if mode !='regular' %}style="display:none" {% endif %}>
            <label for="resultLimit" class="form-label">Number of Results:</label>
            <input type="number" class="form-control form-control-sm w-25" name="result_limit" id="resultLimit"
              placeholder="Default: 100" value="{{ result_limit }}">
          </div>
          <div class="mb-3" id="aiResultLimitGroup" {% if mode !='aggregate' %}style="display:none" {% endif %}>
            <label for="aiResultLimit" class="form-label">Number of AI-Ranked Results:</label>
            <input type="number" class="form-control form-control-sm w-25" name="ai_result_limit" id="aiResultLimit"
              placeholder="Default: 10" value="{{ ai_result_limit }}">
          </div>
        </form>

        <!-- Results section - always present -->
        <div class="card" id="resultsSection" {% if not results %}style="display: none;"{% endif %}>
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              Search Results for <strong id="queryDisplay">{{ query if query else "Previous Search" }}</strong>
              <span class="badge bg-secondary ms-2" id="resultsCount">{{ papersCount if papersCount else 0 }} papers found</span>
            </div>
            <div class="d-flex align-items-center gap-2" id="sortControls">
              <label for="sortBy" class="form-label mb-0 text-white">Sort by:</label>
              <select id="sortBy" class="form-select form-select-sm" style="width: auto;">
                <option value="default">Default Order</option>
                <option value="citations-desc">Citations (High to Low)</option>
                <option value="citations-asc">Citations (Low to High)</option>
                <option value="year-desc">Year (Newest First)</option>
                <option value="year-asc">Year (Oldest First)</option>
                <option value="title-asc">Title (A-Z)</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div id="resultsContent" class="card-text">
              {% if results %}
                {% for source_result in results %}
                  <h4>{{ source_result.source }} results:</h4>
                  <ul>
                    {% for paper in source_result.papers %}
                      <li>
                        <strong>{{ paper.title }}</strong> ({{ paper.year }})<br>
                        <strong>Authors</strong>: {{ paper.authors }}<br>
                        <strong>Citations</strong>: {{ paper.citations }}<br>
                        <a href='{{ paper.url }}' target='_blank'>Read More</a>
                        {% if paper.explanation %}
                          <br><em>{{ paper.explanation }}</em>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% endfor %}
              {% else %}
                <p class="text-muted">No results to display. Click on a previous search or perform a new search.</p>
              {% endif %}
            </div>
          </div>
        </div>
        
        {% if query and not results %}
        <div class="alert alert-warning text-center" role="alert">
          No results found for your search query: <strong>{{ query }}</strong>.
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <button id="backToTopButton" class="btn btn-primary"
    style="position: fixed; bottom: 20px; right: 20px; display: none; z-index: 1000;">
    ↑
  </button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/darkmode.js') }}"></script>
  <script src="{{ url_for('static', filename='js/loader.js') }}"></script>
  <script src="{{ url_for('static', filename='js/history.js') }}"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/scrollToTop.js') }}"></script>
  <script src="{{ url_for('static', filename='js/results_toggle.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ranking_mode.js') }}"></script>
  <script src="{{ url_for('static', filename='js/results_sorting.js') }}"></script>

  {% if results and query %}
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      setTimeout(function() {
        window.currentQuery = "{{ query }}";
        window.currentResultsHTML = document.getElementById('resultsContent').innerHTML;
        window.currentSource = "{{ 'aggregate' if mode == 'aggregate' else selected_backend }}";
        
        if (window.addSearchHistory && window.currentQuery && window.currentResultsHTML) {
          window.addSearchHistory(window.currentQuery, window.currentResultsHTML, window.currentSource);
        }
      }, 100);
    });
  </script>
  {% endif %}
</body>

</html>