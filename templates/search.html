{% extends "base.html" %}

{% block title %}Advanced Search - AI Scholar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
{% endblock %}

{% block body_class %}search-page{% endblock %}

{% block content %}
<div class="search-container">
    <!-- Search Form -->
    <div class="search-form animate-on-scroll">
        <h2><i class="fas fa-search me-2"></i>Advanced Search</h2>
        <form method="POST" novalidate>
            <!-- Main Query -->
            <div class="form-group">
                <label for="query">
                    <i class="fas fa-edit me-1"></i>Search Query:
                </label>
                <input type="text" 
                       id="query" 
                       name="query" 
                       value="{{ query }}" 
                       placeholder="Enter your research query..." 
                       required
                       autocomplete="off">
            </div>
            
            <!-- First Row: Provider and Mode -->
            <div class="form-row">
                <div class="form-group">
                    <label for="backend">
                        <i class="fas fa-database me-1"></i>Search Provider:
                    </label>
                    <select id="backend" name="backend">
                        <option value="">All Providers</option>
                        <option value="crossref" {% if selected_backend == 'crossref' %}selected{% endif %}>CrossRef</option>
                        <option value="arxiv" {% if selected_backend == 'arxiv' %}selected{% endif %}>arXiv</option>
                        <option value="semantic_scholar" {% if selected_backend == 'semantic_scholar' %}selected{% endif %}>Semantic Scholar</option>
                        <option value="core" {% if selected_backend == 'core' %}selected{% endif %}>CORE</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="mode">
                        <i class="fas fa-sliders-h me-1"></i>Search Mode:
                    </label>
                    <select id="mode" name="mode">
                        <option value="" {% if mode == '' %}selected{% endif %}>Single Provider</option>
                        <option value="aggregate" {% if mode == 'aggregate' %}selected{% endif %}>Aggregate & Rank</option>
                    </select>
                </div>
            </div>
            
            <!-- Second Row: Year Filters -->
            <div class="form-row">
                <div class="form-group">
                    <label for="min_year">
                        <i class="fas fa-calendar-alt me-1"></i>Min Year:
                    </label>
                    <input type="number" 
                           id="min_year" 
                           name="min_year" 
                           value="{{ min_year }}" 
                           placeholder="2020"
                           min="1900"
                           max="2030">
                </div>
                
                <div class="form-group">
                    <label for="max_year">
                        <i class="fas fa-calendar-check me-1"></i>Max Year:
                    </label>
                    <input type="number" 
                           id="max_year" 
                           name="max_year" 
                           value="{{ max_year }}" 
                           placeholder="2024"
                           min="1900"
                           max="2030">
                </div>
                
                <div class="form-group">
                    <label for="result_limit">
                        <i class="fas fa-list-ol me-1"></i>Max Results:
                    </label>
                    <input type="number" 
                           id="result_limit" 
                           name="result_limit" 
                           value="{{ result_limit or 20 }}" 
                           min="1" 
                           max="500">
                </div>
            </div>
            
            <!-- Third Row: AI Settings -->
            <div class="form-row ai-results-group" style="display: {% if mode == 'aggregate' %}flex{% else %}none{% endif %};">
                <div class="form-group">
                    <label for="ai_result_limit">
                        <i class="fas fa-robot me-1"></i>AI Ranked Results:
                    </label>
                    <input type="number" 
                           id="ai_result_limit" 
                           name="ai_result_limit" 
                           value="{{ ai_result_limit or 10 }}" 
                           min="1" 
                           max="100">
                </div>
                
                <div class="form-group">
                    <label for="ranking_mode">
                        <i class="fas fa-sort-amount-down me-1"></i>Ranking Mode:
                    </label>
                    <select id="ranking_mode" name="ranking_mode">
                        <option value="ai" {% if ranking_mode == 'ai' %}selected{% endif %}>AI Ranking</option>
                        <option value="citations" {% if ranking_mode == 'citations' %}selected{% endif %}>Citation Count</option>
                        <option value="year" {% if ranking_mode == 'year' %}selected{% endif %}>Publication Year</option>
                    </select>
                </div>
            </div>
            
            <!-- Search Button -->
            <button type="submit" class="search-btn">
                <i class="fas fa-search me-2"></i>Search Papers
            </button>
        </form>
    </div>
    
    <!-- Results Section -->
    {% if results %}
    <div class="results-container animate-on-scroll">
        <div class="results-header">
            <h2><i class="fas fa-file-alt me-2"></i>Search Results</h2>
            <span class="results-count">{{ papersCount }} papers found</span>
        </div>
        
        {% for result_group in results %}
        <div class="result-group">
            <h3>
                <i class="fas fa-folder-open me-2"></i>
                {{ result_group['source'].title() }} 
                <small>({{ result_group['papers']|length }} papers)</small>
            </h3>
            
            {% for paper in result_group['papers'] %}
            <div class="result-item shadow-hover" tabindex="0">
                <h4>
                    <a href="{{ paper['url'] }}" target="_blank" rel="noopener">
                        {{ paper['title'] }}
                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                    </a>
                </h4>
                
                <div class="result-meta">
                    <span><strong><i class="fas fa-users me-1"></i>Authors:</strong> {{ paper['authors'] or 'N/A' }}</span>
                    <span><strong><i class="fas fa-calendar me-1"></i>Year:</strong> {{ paper['year'] or 'N/A' }}</span>
                    <span><strong><i class="fas fa-quote-right me-1"></i>Citations:</strong> {{ paper['citations'] or 'N/A' }}</span>
                    {% if paper['doi'] %}
                    <span><strong><i class="fas fa-link me-1"></i>DOI:</strong> {{ paper['doi'] }}</span>
                    {% endif %}
                </div>
                
                {% if paper['explanation'] %}
                <div class="ai-explanation">
                    <strong><i class="fas fa-robot me-1"></i>AI Ranking:</strong> 
                    {{ paper['explanation'] }}
                </div>
                {% endif %}
                
                <div style="margin-top: 10px;">
                    <button class="btn btn-sm btn-outline-secondary copy-citation" type="button">
                        <i class="fas fa-copy me-1"></i>Copy Citation
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
{% endblock %}
