{% extends "base.html" %}

{% block title %}Advanced Search - AI Scholar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">                            <div class="col-md-6">
                                <h6>Provider Collection:</h6>
                                <ul class="list-unstyled">
                                    {% for provider, stats in aggregation_stats.providers_used.items() %}
                                    <li>
                                        <strong>{{ provider.replace('_', ' ').title() }}:</strong>
                                        {{ stats.raw_count }} → {{ stats.after_filter }} papers
                                        {% if ranking_mode == 'citations' and provider in ['semantic_scholar', 'crossref', 'openalex'] %}
                                        <span class="badge bg-success ms-1">Citation-Enhanced</span>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% if ranking_mode == 'citations' %}
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ArXiv excluded in citation mode (no citation data)
                                </small>
                                {% endif %}
                            </div>k %}

{% block body_class %}search-page{% endblock %}

{% block content %}
<div class="search-container">
    <!-- Search Form -->
    <div class="search-form animate-on-scroll">
        <h2><i class="fas fa-search me-2"></i>Advanced Search</h2>
        <form method="POST" novalidate>
            <!-- Main Query -->
            <div class="form-group">
                <label for="query">
                    <i class="fas fa-edit me-1"></i>Search Query:
                </label>
                <input type="text" 
                       id="query" 
                       name="query" 
                       value="{{ query }}" 
                       placeholder="Enter your research query..." 
                       required
                       autocomplete="off">
            </div>
            
            <!-- First Row: Provider and Mode -->
            <div class="form-row">
                <div class="form-group">
                    <label for="backend">
                        <i class="fas fa-database me-1"></i>Search Provider:
                    </label>
                    <select id="backend" name="backend">
                        <option value="">All Providers</option>
                        <option value="crossref" {% if selected_backend == 'crossref' %}selected{% endif %}>CrossRef</option>
                        <option value="arxiv" {% if selected_backend == 'arxiv' %}selected{% endif %}>arXiv</option>
                        <option value="semantic_scholar" {% if selected_backend == 'semantic_scholar' %}selected{% endif %}>Semantic Scholar</option>
                        <option value="core" {% if selected_backend == 'core' %}selected{% endif %}>CORE</option>
                        <option value="openalex" {% if selected_backend == 'openalex' %}selected{% endif %}>OpenAlex</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="mode">
                        <i class="fas fa-sliders-h me-1"></i>Search Mode:
                    </label>
                    <select id="mode" name="mode">
                        <option value="" {% if mode == '' %}selected{% endif %}>Single Provider</option>
                        <option value="aggregate" {% if mode == 'aggregate' %}selected{% endif %}>Aggregate & Rank</option>
                    </select>
                </div>
            </div>
            
            <!-- Second Row: Year Filters -->
            <div class="form-row">
                <div class="form-group">
                    <label for="min_year">
                        <i class="fas fa-calendar-alt me-1"></i>Min Year:
                    </label>
                    <input type="number" 
                           id="min_year" 
                           name="min_year" 
                           value="{{ min_year }}" 
                           placeholder="2020"
                           min="1900"
                           max="2030">
                </div>
                
                <div class="form-group">
                    <label for="max_year">
                        <i class="fas fa-calendar-check me-1"></i>Max Year:
                    </label>
                    <input type="number" 
                           id="max_year" 
                           name="max_year" 
                           value="{{ max_year }}" 
                           placeholder="2024"
                           min="1900"
                           max="2030">
                </div>
                
                <div class="form-group">
                    <label for="result_limit">
                        <i class="fas fa-list-ol me-1"></i>Max Results:
                    </label>
                    <input type="number" 
                           id="result_limit" 
                           name="result_limit" 
                           value="{{ result_limit or 20 }}" 
                           min="1" 
                           max="500">
                </div>
            </div>
            
            <!-- Third Row: AI Settings -->
            <div class="form-row ai-results-group" style="display: {% if mode == 'aggregate' %}flex{% else %}none{% endif %};">
                <div class="form-group">
                    <label for="ai_result_limit">
                        <i class="fas fa-robot me-1"></i>AI Ranked Results:
                    </label>
                    <input type="number" 
                           id="ai_result_limit" 
                           name="ai_result_limit" 
                           value="{{ ai_result_limit or 10 }}" 
                           min="1" 
                           max="100">
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Optimized aggregation: Up to 200 papers pre-ranked, then AI selects the best matches
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="ranking_mode">
                        <i class="fas fa-sort-amount-down me-1"></i>Ranking Mode:
                    </label>
                    <select id="ranking_mode" name="ranking_mode">
                        <option value="ai" {% if ranking_mode == 'ai' %}selected{% endif %}>AI Ranking</option>
                        <option value="citations" {% if ranking_mode == 'citations' %}selected{% endif %}>Most Cited Papers</option>
                        <option value="year" {% if ranking_mode == 'year' %}selected{% endif %}>Newest Papers First</option>
                    </select>
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        <span id="ranking-help-text">
                            {% if ranking_mode == 'citations' %}
                            Most Cited: Focuses on providers with citation data, optimized to find highly cited papers
                            {% elif ranking_mode == 'year' %}
                            Newest Papers: Optimized for recent and relevant papers using all providers with intelligent recency-relevance scoring
                            {% else %}
                            AI Ranking: Uses AI to rank papers by relevance to your query
                            {% endif %}
                        </span>
                    </small>
                </div>
            </div>
            
            <!-- Search Button -->
            <button type="submit" class="search-btn">
                <i class="fas fa-search me-2"></i>Search Papers
            </button>
        </form>
    </div>
    
    <!-- Results Section -->
    {% if results %}
    <div class="results-container animate-on-scroll">
                        <!-- Aggregation Statistics (for aggregate mode) -->
        {% if mode == 'aggregate' and aggregation_stats %}
        <div class="aggregation-stats mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Aggregation Process Summary
                        {% if ranking_mode == 'citations' %}
                        <span class="badge bg-info ms-2">Citation-Optimized</span>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#statsDetails" 
                                aria-expanded="false" aria-controls="statsDetails">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number">{{ aggregation_stats.total_collected }}</div>
                                <div class="stat-label">Papers Collected</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number">{{ aggregation_stats.after_dedup }}</div>
                                <div class="stat-label">After Deduplication</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number">{{ aggregation_stats.sent_to_ai }}</div>
                                <div class="stat-label">Sent to AI</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number">{{ papersCount }}</div>
                                <div class="stat-label">Final Results</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="collapse mt-3" id="statsDetails">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Provider Breakdown:</h6>
                                <ul class="list-unstyled">
                                    {% for provider, stats in aggregation_stats.providers_used.items() %}
                                    <li>
                                        <strong>{{ provider.replace('_', ' ').title() }}:</strong>
                                        {{ stats.raw_count }} → {{ stats.after_filter }} papers
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Optimization Applied:</h6>
                                <ul class="list-unstyled">
                                    <li>
                                        <i class="fas fa-filter me-1"></i>
                                        Quality pre-filtering: 
                                        <span class="badge bg-success">✓ Applied</span>
                                    </li>
                                    <li>
                                        <i class="fas fa-clone me-1"></i>
                                        Duplicate removal: 
                                        <span class="badge bg-success">✓ Applied</span>
                                    </li>
                                    <li>
                                        <i class="fas fa-sort me-1"></i>
                                        Pre-ranking: 
                                        {% if aggregation_stats.pre_ranking_applied %}
                                        <span class="badge bg-success">✓ Applied</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Not needed</span>
                                        {% endif %}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="results-header">
            <h2><i class="fas fa-file-alt me-2"></i>Search Results</h2>
            <div class="results-controls">
                <span class="results-count">{{ papersCount }} papers found</span>
                <div class="filter-controls">
                    <label for="result-filter" class="filter-label">
                        <i class="fas fa-filter me-1"></i>Sort by:
                    </label>
                    <select id="result-filter" class="filter-select result-filter">
                        <option value="default">Default Order</option>
                        <option value="citations">Citations (High to Low)</option>
                        <option value="year">Year (Newest First)</option>
                        <option value="title">Title (A-Z)</option>
                        {% if mode == 'aggregate' %}
                        <option value="provider">Provider</option>
                        {% endif %}
                    </select>
                </div>
            </div>
        </div>
        
        {% for result_group in results %}
        <div class="result-group">
            <h3>
                <i class="fas fa-folder-open me-2"></i>
                {{ result_group['source'].title() }} 
                <small>({{ result_group['papers']|length }} papers)</small>
            </h3>
            
            {% for paper in result_group['papers'] %}
            <div class="result-item shadow-hover" tabindex="0">
                <h4>
                    <a href="{{ paper['url'] }}" target="_blank" rel="noopener">
                        {{ paper['title'] }}
                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                    </a>
                </h4>
                
                <div class="result-meta">
                    <span><strong><i class="fas fa-users me-1"></i>Authors:</strong> {{ paper['authors'] or 'N/A' }}</span>
                    <span><strong><i class="fas fa-calendar me-1"></i>Year:</strong> {{ paper['year'] or 'N/A' }}</span>
                    <span><strong><i class="fas fa-quote-right me-1"></i>Citations:</strong> {{ paper['citations'] or 'N/A' }}</span>
                    {% if paper['doi'] %}
                    <span><strong><i class="fas fa-link me-1"></i>DOI:</strong> {{ paper['doi'] }}</span>
                    {% endif %}
                </div>
                
                {% if paper['explanation'] %}
                <div class="ai-explanation">
                    <strong><i class="fas fa-robot me-1"></i>AI Ranking:</strong> 
                    {{ paper['explanation'] }}
                </div>
                {% endif %}
                
                <div style="margin-top: 10px;">
                    <button class="btn btn-sm btn-outline-secondary copy-citation" type="button">
                        <i class="fas fa-copy me-1"></i>Copy Citation
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
{% endblock %}
